{{define "head"}}
<title>goweb</title>
<script type="text/javascript" name="connection">
    var times = 0;
    var domain = window.location.host;
    var ds = domain.split(":");
    if (ds.length > 1) {
        domain = ds[0];
    }
    var wsurl = "ws://" + domain + ":8081/ws"
    var ws;
    var heartbeattime = 1000*10;

    var connect = function () {
        ws = new WebSocket(wsurl);
        console.log("ws newed");
        ws.onopen = wsonopen;
        ws.onclose = wsonclose;
        ws.onerror = wsonerror;
        ws.onmessage = wsonmessage;
        ws.retry = true;
    }

    var wsonopen = function (evt) {
        console.log("ws open");
        ws.send("Hello WebSockets!");
        ws.lastHeartbeatTime = Date.now();
        setTimeout("heartbeat();",heartbeattime);
    };

    var wsonmessage = function (evt) {
        console.log("ws receive:" + evt.data);
        appendMsg(evt.data);
        times++;
        if (times > 13){
            ws.retry = false;
        }
    };

    var wsonclose = function (evt) {
        console.log("ws closed:" + evt.data);
        if (evt.target.retry) {
            console.log("reconnect");
            connect();
        }
    };

    var wsonerror = function (evt) {
        console.log("ws error:" + evt.data)
        ws.close();
    };

    var heartbeat = function () {
        switch (ws.readyState) {
            case WebSocket.OPEN:
            sendMsg("heartbeat","");
            ws.lastHeartbeatTime = Date.now();
        }
        setTimeout("heartbeat();",heartbeattime);
        if (Date.now() - ws.lastHeartbeatTime > heartbeattime+5000){
            console.log("connection break");
        }
    };

    var sendMsg = function (type, data) {
        msg = new Object();
        msg.type = type;
        msg.time = Date.now();
        msg.data = data;
        s = JSON.stringify(msg);
        ws.send(s);
    };

    connect();

</script> 
<script type="text/javascript" name="init">
var appendMsg=function(msg){
    content = document.getElementById("content1");
    if (content){
        a = document.createElement("a");
        a.innerHTML = msg;
        content.appendChild(a);
        br = document.createElement("br");
        content.appendChild(br);

    }
}


</script>

{{end}}